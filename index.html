<!-- feat: URLクエリ指定時に1ピンを復元表示できるよう対応 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>今昔マップ（Phase 0.7.3）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .leaflet-bar button {
      background: #fff;
      border: 1px solid #ccc;
      padding: 6px 10px;
      cursor: pointer;
      font-family: Meiryo, sans-serif;
      font-size: 13px;
    }
    .leaflet-bar button:hover { background: #f0f0f0; }

    .popup-wrap {
      font-family: Meiryo, sans-serif;
      font-size: 13px;
      line-height: 1.4;
      min-width: 260px;
    }
    .popup-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .popup-meta {
      color: #333;
      margin-bottom: 8px;
    }
    .popup-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0;
    }
    .popup-actions button {
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .danger {
      border: 1px solid #d33;
      background: #fff5f5;
    }

    .compare {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px;
      background: #fff;
      flex: 1 1 140px;
      min-width: 140px;
      max-width: 240px;
    }
    .card h4 {
      margin: 0 0 4px 0;
      font-size: 12px;
    }
    .card .year {
      font-size: 11px;
      color: #666;
      margin-bottom: 4px;
    }
    .card img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 4px;
      border: 1px solid #eee;
    }
    .noimg {
      font-size: 12px;
      color: #888;
      padding: 14px 6px;
      border: 1px dashed #ccc;
      border-radius: 4px;
      text-align: center;
      background: #fafafa;
    }

    .links a {
      display: inline-block;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const DEFAULT_VIEW = { lat: 35.619123, lng: 139.728456, z: 18 };
    const STORAGE_KEY = "ima-mukashi-pins-v1";

    function loadPins() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { return []; }
    }
    function savePins(pins) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(pins));
    }

    function fmt(n) { return Number(n).toFixed(6); }
    function makeId() {
      return "pin_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
    }
    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function isProbablyUrl(s) {
      if (!s) return false;
      try { new URL(s); return true; } catch { return false; }
    }

    function googleMapsUrl(lat, lng) {
      return `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
    }
    function streetViewUrl(lat, lng) {
      return `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`;
    }

    const map = L.map("map").setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.z);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
      maxZoom: 19
    }).addTo(map);

    const ResetControl = L.Control.extend({
      options: { position: "topleft" },
      onAdd: function () {
        const container = L.DomUtil.create("div", "leaflet-bar");
        const btn = L.DomUtil.create("button", "", container);
        btn.textContent = "初期位置に戻る";
        L.DomEvent.disableClickPropagation(container);
        btn.onclick = () => map.setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.z);
        return container;
      }
    });
    map.addControl(new ResetControl());

    const markerById = new Map();

    function buildCompareCardHtml(title, year, url) {
      const safeTitle = escapeHtml(title);
      const safeYear  = escapeHtml(year);
      if (isProbablyUrl(url)) {
        const safeUrl = escapeHtml(url);
        return `
          <div class="card">
            <h4>${safeTitle}</h4>
            <div class="year">${safeYear}</div>
            <img src="${safeUrl}" loading="lazy">
          </div>
        `;
      }
      return `
        <div class="card">
          <h4>${safeTitle}</h4>
          <div class="year">${safeYear}</div>
          <div class="noimg">画像なし</div>
        </div>
      `;
    }

    function confirmedPopupHtml(pin) {
      const latStr = fmt(pin.lat);
      const lngStr = fmt(pin.lng);

      return `
        <div class="popup-wrap" data-pin-id="${escapeHtml(pin.id)}">
          <div class="popup-title">${escapeHtml(pin.title)}</div>
          <div class="popup-meta">
            年代: ${escapeHtml(pin.year || "不明")}<br>
            lat: ${latStr}<br>
            lng: ${lngStr}
          </div>

          <div class="compare">
            ${buildCompareCardHtml("昔", pin.year, pin.mukashiUrl)}
            ${buildCompareCardHtml("今", pin.year, pin.imaUrl)}
          </div>

          <div class="links">
            <a href="${googleMapsUrl(latStr, lngStr)}" target="_blank">Googleマップで開く</a><br>
            <a href="${streetViewUrl(latStr, lngStr)}" target="_blank">ストリートビューで開く</a>
          </div>

          <div class="popup-actions">
            <button class="btn-delete danger" type="button">このピンを削除</button>
          </div>
        </div>
      `;
    }

    function addConfirmedMarker(pin, openPopup = false) {
      const marker = L.marker([pin.lat, pin.lng]).addTo(map);
      marker.bindPopup(confirmedPopupHtml(pin));
      markerById.set(pin.id, marker);
      if (openPopup) marker.openPopup();
    }

    function removeConfirmedPin(pinId) {
      const pins = loadPins();
      savePins(pins.filter(p => p.id !== pinId));
      const marker = markerById.get(pinId);
      if (marker) map.removeLayer(marker);
    }

    loadPins().forEach(pin => addConfirmedMarker(pin));

    function addPinFromQueryIfExists() {
      const p = new URLSearchParams(location.search);
      if (!p.get("lat") || !p.get("lng") || !p.get("title")) return;

      const pin = {
        id: "shared_" + Date.now(),
        lat: Number(p.get("lat")),
        lng: Number(p.get("lng")),
        title: p.get("title"),
        year: p.get("year") || "",
        mukashiUrl: p.get("mukashi") || "",
        imaUrl: p.get("ima") || "",
        createdAt: Date.now()
      };

      addConfirmedMarker(pin, true);
      map.setView([pin.lat, pin.lng], DEFAULT_VIEW.z);
    }

    addPinFromQueryIfExists();
  </script>
</body>
</html>
