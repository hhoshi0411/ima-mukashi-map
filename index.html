<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>今昔マップ（Phase 0.7.2）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .leaflet-bar button {
      background: #fff;
      border: 1px solid #ccc;
      padding: 6px 10px;
      cursor: pointer;
      font-family: Meiryo, sans-serif;
      font-size: 13px;
    }
    .leaflet-bar button:hover { background: #f0f0f0; }

    .popup-wrap {
      font-family: Meiryo, sans-serif;
      font-size: 13px;
      line-height: 1.4;
      min-width: 260px;
    }
    .popup-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .popup-meta {
      color: #333;
      margin-bottom: 8px;
    }
    .popup-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0;
    }
    .popup-actions button {
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .danger {
      border: 1px solid #d33;
      background: #fff5f5;
    }

    .draft-form label {
      display: block;
      margin: 6px 0 2px;
      font-weight: bold;
    }
    .draft-form input {
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
      font-family: Meiryo, sans-serif;
      font-size: 13px;
    }
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .compare {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px;
      background: #fff;
      flex: 1 1 140px;
      min-width: 140px;
      max-width: 240px;
    }
    .card h4 {
      margin: 0 0 4px 0;
      font-size: 12px;
    }
    .card .year {
      font-size: 11px;
      color: #666;
      margin-bottom: 4px;
    }
    .card img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 4px;
      border: 1px solid #eee;
    }
    .noimg {
      font-size: 12px;
      color: #888;
      padding: 14px 6px;
      border: 1px dashed #ccc;
      border-radius: 4px;
      text-align: center;
      background: #fafafa;
    }

    .links a {
      display: inline-block;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    /****************************************************
     * Phase 0.7.2
     * - 仮ピン popupopen 登録後に openPopup するよう修正
     ****************************************************/

    const DEFAULT_VIEW = { lat: 35.619123, lng: 139.728456, z: 18 };
    const STORAGE_KEY = "ima-mukashi-pins-v1";

    function loadPins() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { return []; }
    }
    function savePins(pins) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(pins));
    }

    function fmt(n) { return Number(n).toFixed(6); }
    function makeId() {
      return "pin_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
    }
    function googleMapsUrl(lat, lng) {
      return `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
    }
    function streetViewUrl(lat, lng) {
      return `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`;
    }
    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function isProbablyUrl(s) {
      if (!s) return false;
      try { new URL(s); return true; } catch { return false; }
    }

    const map = L.map("map").setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.z);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
      maxZoom: 19
    }).addTo(map);

    const ResetControl = L.Control.extend({
      options: { position: "topleft" },
      onAdd: function () {
        const container = L.DomUtil.create("div", "leaflet-bar");
        const btn = L.DomUtil.create("button", "", container);
        btn.textContent = "初期位置に戻る";
        L.DomEvent.disableClickPropagation(container);
        btn.onclick = () => map.setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.z);
        return container;
      }
    });
    map.addControl(new ResetControl());

    const markerById = new Map();

    function buildCompareCardHtml(title, year, url) {
      const safeTitle = escapeHtml(title);
      const safeYear  = escapeHtml(year);
      if (isProbablyUrl(url)) {
        const safeUrl = escapeHtml(url);
        return `
          <div class="card">
            <h4>${safeTitle}</h4>
            <div class="year">${safeYear || ""}</div>
            <img src="${safeUrl}" alt="${safeTitle}" loading="lazy" />
          </div>
        `;
      }
      return `
        <div class="card">
          <h4>${safeTitle}</h4>
          <div class="year">${safeYear || ""}</div>
          <div class="noimg">画像URL未設定</div>
        </div>
      `;
    }

    function confirmedPopupHtml(pin) {
      const latStr = fmt(pin.lat);
      const lngStr = fmt(pin.lng);
      const title = escapeHtml(pin.title || "（無題）");
      const year  = escapeHtml(pin.year || "");

      return `
        <div class="popup-wrap" data-pin-id="${escapeHtml(pin.id)}">
          <div class="popup-title">${title}</div>
          <div class="popup-meta">
            ${year ? `年代: ${year}<br>` : ""}
            lat: ${latStr}<br>
            lng: ${lngStr}
          </div>

          <div class="compare">
            ${buildCompareCardHtml("昔", year, pin.mukashiUrl)}
            ${buildCompareCardHtml("今", year, pin.imaUrl)}
          </div>

          <div class="links">
            <a href="${googleMapsUrl(latStr, lngStr)}" target="_blank" rel="noopener noreferrer">Googleマップで開く</a><br>
            <a href="${streetViewUrl(latStr, lngStr)}" target="_blank" rel="noopener noreferrer">ストリートビューで開く</a>
          </div>

          <div class="popup-actions">
            <button class="btn-delete danger" type="button">このピンを削除</button>
          </div>
        </div>
      `;
    }

    function addConfirmedMarker(pin, openPopup = false) {
      const marker = L.marker([pin.lat, pin.lng]).addTo(map);
      marker.bindPopup(confirmedPopupHtml(pin));
      markerById.set(pin.id, marker);
      if (openPopup) marker.openPopup();
    }

    function removeConfirmedPin(pinId) {
      const pins = loadPins();
      savePins(pins.filter(p => p.id !== pinId));
      const marker = markerById.get(pinId);
      if (marker) {
        map.removeLayer(marker);
        markerById.delete(pinId);
      }
    }

    loadPins().forEach(pin => addConfirmedMarker(pin));

    map.on("popupopen", (e) => {
      const el = e.popup.getElement();
      if (!el) return;

      L.DomEvent.disableClickPropagation(el);
      L.DomEvent.disableScrollPropagation(el);

      const wrap = el.querySelector(".popup-wrap");
      if (!wrap) return;

      const pinId = wrap.getAttribute("data-pin-id");
      const delBtn = el.querySelector(".btn-delete");
      if (delBtn) {
        delBtn.onclick = (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          if (window.confirm("この確定ピンを削除します。よろしいですか？")) {
            removeConfirmedPin(pinId);
          }
        };
      }
    });

    let draftMarker = null;

    function clearDraft() {
      if (draftMarker) {
        map.removeLayer(draftMarker);
        draftMarker = null;
      }
    }

    function draftPopupHtml(lat, lng) {
      return `
        <div class="popup-wrap">
          <div class="popup-title">仮ピン（入力して確定）</div>
          <div class="popup-meta">
            lat: ${fmt(lat)}<br>
            lng: ${fmt(lng)}
          </div>

          <div class="draft-form">
            <label>タイトル</label>
            <input type="text" id="f_title" />

            <label>年代</label>
            <input type="text" id="f_year" />

            <label>昔写真URL</label>
            <input type="url" id="f_mukashi" />

            <label>今写真URL</label>
            <input type="url" id="f_ima" />
          </div>

          <div class="popup-actions">
            <button id="btn_confirm" type="button">確定（保存）</button>
            <button id="btn_cancel" type="button">キャンセル</button>
          </div>
        </div>
      `;
    }

    map.on("click", (e) => {
      const { lat, lng } = e.latlng;

      clearDraft();
      map.setView([lat, lng], DEFAULT_VIEW.z);

      draftMarker = L.marker([lat, lng]).addTo(map);
      draftMarker.bindPopup(draftPopupHtml(lat, lng));

      draftMarker.once("popupclose", clearDraft);

      draftMarker.on("popupopen", (ev) => {
        const root = ev.popup.getElement();
        if (!root) return;

        L.DomEvent.disableClickPropagation(root);
        L.DomEvent.disableScrollPropagation(root);

        const titleEl   = root.querySelector("#f_title");
        const yearEl    = root.querySelector("#f_year");
        const mukashiEl = root.querySelector("#f_mukashi");
        const imaEl     = root.querySelector("#f_ima");

        root.querySelector("#btn_cancel").onclick = (ev2) => {
          ev2.preventDefault();
          ev2.stopPropagation();
          clearDraft();
        };

        root.querySelector("#btn_confirm").onclick = (ev2) => {
          ev2.preventDefault();
          ev2.stopPropagation();

          const title = titleEl.value.trim();
          if (!title) {
            alert("タイトルを入力してください。");
            return;
          }

          const pin = {
            id: makeId(),
            lat, lng,
            title,
            year: yearEl.value.trim(),
            mukashiUrl: mukashiEl.value.trim(),
            imaUrl: imaEl.value.trim(),
            createdAt: Date.now()
          };

          const pins = loadPins();
          pins.push(pin);
          savePins(pins);

          clearDraft();
          addConfirmedMarker(pin, true);
        };
      });

      // ★最後に開く（重要）
      draftMarker.openPopup();
    });
  </script>
</body>
</html>
